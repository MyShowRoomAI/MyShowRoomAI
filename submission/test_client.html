<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyShowRoom AI - Submission Tester</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f7; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h1 { color: #1d1d1f; margin-bottom: 20px; }
        h2 { color: #1d1d1f; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid #d2d2d7; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { background: #0071e3; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; transition: background 0.2s; }
        button:hover { background: #0077ed; }
        button:disabled { background: #999; cursor: not-allowed; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { background: #e5e5ea; color: #1d1d1f; flex: 1; text-align: center; }
        .tab-btn.active { background: #0071e3; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Canvas & Images */
        canvas { max-width: 100%; border: 1px solid #ccc; cursor: crosshair; }
        .preview-img { max-width: 100%; border-radius: 8px; margin-top: 10px; }
        .result-container { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; }
        .result-item { flex: 1; min-width: 300px; background: #fbfbfd; padding: 15px; border-radius: 8px; border: 1px solid #e5e5ea; }

        /* Consult Items */
        .consult-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 8px; background: white; }
        .consult-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .badge { background: #e5e5ea; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .model-link { color: #0071e3; text-decoration: none; font-weight: bold; }

        .log { background: #1d1d1f; color: #39ff14; padding: 15px; border-radius: 8px; font-family: monospace; height: 150px; overflow-y: auto; margin-top: 20px; }
        .loading { display: none; color: #0071e3; font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ† MyShowRoom AI - Submission Tester</h1>
    
    <div class="card">
        <label>ğŸ”— Ngrok Public URL</label>
        <input type="text" id="serverUrl" placeholder="https://xxxx.ngrok-free.app (ë’¤ì— ìŠ¬ë˜ì‹œ ì—†ì´)" value="">
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('consult')">ğŸ›‹ï¸ Consult (Recsys)</button>
        <button class="tab-btn" onclick="showTab('remove')">ğŸ§¹ Remove Object</button>
        <button class="tab-btn" onclick="showTab('analyze')">ğŸ“ Analyze Room</button>
    </div>

    <!-- Tab 1: Consult -->
    <div id="consult" class="tab-content active card">
        <h2>ê°€êµ¬ ì¶”ì²œ (5 Items)</h2>
        <div class="input-group">
            <label>1. ë°© ì‚¬ì§„ ì—…ë¡œë“œ</label>
            <input type="file" id="consultFile" accept="image/*">
            <img id="consultPreview" class="preview-img" style="display:none; max-height: 200px;">
        </div>
        <div class="input-group">
            <label>2. ìš”ì²­ ì‚¬í•­ (User Prompt)</label>
            <textarea id="userPrompt" rows="3" placeholder="ì˜ˆ: ëª¨ë˜í•œ ëŠë‚Œì˜ ê±°ì‹¤ì„ ê¾¸ë¯¸ê³  ì‹¶ì–´. í¸ì•ˆí•œ ì†ŒíŒŒ ì¶”ì²œí•´ì¤˜."></textarea>
        </div>
        <button onclick="runConsult()">ğŸ” ì¶”ì²œ ë°›ê¸°</button>
        <div id="consultLoading" class="loading">ğŸ¤” Geminiê°€ ê°€êµ¬ë¥¼ ê³ ë¥´ëŠ” ì¤‘ì…ë‹ˆë‹¤... (ì•½ 10~20ì´ˆ)</div>
        <div id="consultResult" style="margin-top: 20px;"></div>
    </div>

    <!-- Tab 2: Remove Object -->
    <div id="remove" class="tab-content card">
        <h2>ë¬¼ì²´ ì‚­ì œ (Inpainting)</h2>
        <div class="input-group">
            <label>ì´ë¯¸ì§€ ì—…ë¡œë“œ & í´ë¦­</label>
            <input type="file" id="removeFile" accept="image/*">
        </div>
        <div>
            <p>ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ì—¬ <b>ì§€ìš¸ ë¬¼ì²´</b>ë¥¼ ì„ íƒí•˜ì„¸ìš”. (ì¢Œí‘œ: <span id="coordsDisplay">-</span>)</p>
            <canvas id="removeCanvas"></canvas>
        </div>
        <button id="btnRemove" onclick="runRemove()" disabled style="margin-top: 10px;">âœ¨ ë¬¼ì²´ ì§€ìš°ê¸°</button>
        <div id="removeLoading" class="loading">ğŸ¨ AIê°€ ê·¸ë¦¼ì„ ë‹¤ì‹œ ê·¸ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        <div id="removeResult" class="result-container"></div>
    </div>

    <!-- Tab 3: Analyze -->
    <div id="analyze" class="tab-content card">
        <h2>ë°© êµ¬ì¡° ë¶„ì„ (Floor Boundary)</h2>
        <div class="input-group">
            <label>ì´ë¯¸ì§€ ì—…ë¡œë“œ</label>
            <input type="file" id="analyzeFile" accept="image/*">
        </div>
        <button onclick="runAnalyze()">ğŸ“ ë¶„ì„ ì‹œì‘</button>
        <div id="analyzeLoading" class="loading">ğŸ“ ë°”ë‹¥ ê²½ê³„ì„ ì„ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...</div>
        <canvas id="analyzeCanvas" style="margin-top:20px; display:none;"></canvas>
    </div>

    <div class="log" id="logArea">Server logs will appear here...</div>

    <script>
        // --- Utils ---
        function log(msg) {
            const el = document.getElementById('logArea');
            const time = new Date().toLocaleTimeString();
            el.innerHTML += `[${time}] ${msg}<br>`;
            el.scrollTop = el.scrollHeight;
        }
        function getServerUrl() {
            const url = document.getElementById('serverUrl').value.replace(/\/$/, "");
            if (!url) { alert("Ngrok URLì„ ì…ë ¥í•˜ì„¸ìš”!"); return null; }
            return url;
        }
        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        }

        // --- Logic: Consult ---
        document.getElementById('consultFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const img = document.getElementById('consultPreview');
                img.src = URL.createObjectURL(file);
                img.style.display = 'block';
            }
        });

        async function runConsult() {
            const url = getServerUrl(); if(!url) return;
            const file = document.getElementById('consultFile').files[0];
            const prompt = document.getElementById('userPrompt').value;
            if (!file || !prompt) return alert("ì´ë¯¸ì§€ì™€ ìš”ì²­ì‚¬í•­ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");

            document.getElementById('consultLoading').style.display = 'block';
            document.getElementById('consultResult').innerHTML = "";
            log("Sending /consult request...");

            const formData = new FormData();
            formData.append("image", file);
            formData.append("user_prompt", prompt);

            try {
                const res = await fetch(`${url}/consult`, { method: 'POST', body: formData });
                const data = await res.json();
                document.getElementById('consultLoading').style.display = 'none';

                if (Array.isArray(data)) {
                    log(`Received ${data.length} recommendations.`);
                    let html = "";
                    data.forEach((item, idx) => {
                        const glbLink = item.item_details?.glb_url 
                            ? `<a href="${item.item_details.glb_url}" target="_blank" class="model-link">ğŸ“¦ 3D Model Download</a> (ID: ${item.selected_id})` 
                            : `<span style="color:#999">No 3D Model</span>`;

                        html += `
                        <div class="consult-card">
                            <div class="consult-header">
                                <h3>#${idx+1} ${item.item_details?.name || item.selected_id}</h3>
                                <span class="badge">${item.item_details?.category || 'Furniture'}</span>
                            </div>
                            <p><b>Reason:</b> ${item.reason}</p>
                            <p><b>Position:</b> ${item.position_suggestion}</p>
                            <div style="margin-top:10px; background:#f0f0f5; padding:10px; border-radius:5px;">
                                ${glbLink}
                            </div>
                        </div>`;
                    });
                    document.getElementById('consultResult').innerHTML = html;
                } else {
                    log("Invalid response format.");
                }
            } catch (e) {
                log("Error: " + e.message);
                document.getElementById('consultLoading').style.display = 'none';
            }
        }

        // --- Logic: Remove Object ---
        let removeImg = null;
        let removeX = 0, removeY = 0;
        let removeScale = 1;
        const rCanvas = document.getElementById('removeCanvas');
        const rCtx = rCanvas.getContext('2d');

        document.getElementById('removeFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const img = new Image();
            img.onload = () => {
                removeImg = img;
                const MAX_W = 600;
                removeScale = img.width > MAX_W ? MAX_W / img.width : 1;
                rCanvas.width = img.width * removeScale;
                rCanvas.height = img.height * removeScale;
                rCtx.drawImage(img, 0, 0, rCanvas.width, rCanvas.height);
                document.getElementById('btnRemove').disabled = true;
                log("Remove Image loaded.");
            };
            img.src = URL.createObjectURL(file);
        });

        rCanvas.addEventListener('click', (e) => {
            if (!removeImg) return;
            const rect = rCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            removeX = Math.round(x / removeScale);
            removeY = Math.round(y / removeScale);
            
            document.getElementById('coordsDisplay').innerText = `${removeX}, ${removeY}`;
            document.getElementById('btnRemove').disabled = false;

            // Redraw point
            rCtx.drawImage(removeImg, 0, 0, rCanvas.width, rCanvas.height);
            rCtx.beginPath();
            rCtx.arc(x, y, 8, 0, 2*Math.PI);
            rCtx.fillStyle = 'red';
            rCtx.fill();
            rCtx.stroke();
        });

        async function runRemove() {
            const url = getServerUrl(); if(!url) return;
            document.getElementById('removeLoading').style.display = 'block';
            log("Sending /remove-object request...");
            
            const formData = new FormData();
            formData.append("file", document.getElementById('removeFile').files[0]);
            formData.append("x", removeX);
            formData.append("y", removeY);

            try {
                const res = await fetch(`${url}/remove-object`, { method: 'POST', body: formData });
                const data = await res.json();
                document.getElementById('removeLoading').style.display = 'none';

                if (data.status === 'success') {
                    const resImg = new Image();
                    resImg.onload = () => {
                        const container = document.getElementById('removeResult');
                        container.innerHTML = ""; // Clear
                        
                        // Result Canvas
                        const c = document.createElement('canvas');
                        const s = 600 / resImg.width;
                        c.width = 600;
                        c.height = resImg.height * s;
                        const ctx = c.getContext('2d');
                        ctx.drawImage(resImg, 0, 0, c.width, c.height);

                        // Draw Boundary
                        if (data.floor_boundary) {
                            ctx.beginPath();
                            ctx.strokeStyle = '#00ff00';
                            ctx.lineWidth = 3;
                            data.floor_boundary.forEach((pt, i) => {
                                const px = pt.x * s, py = pt.y * s;
                                if (i===0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
                            });
                            ctx.stroke();
                        }
                        container.appendChild(c);
                        log("Remove success.");
                    };
                    resImg.src = data.image;
                }
            } catch (e) {
                log("Error: " + e.message);
                document.getElementById('removeLoading').style.display = 'none';
            }
        }

        // --- Logic: Analyze ---
        async function runAnalyze() {
            const url = getServerUrl(); if(!url) return;
            const file = document.getElementById('analyzeFile').files[0];
            if (!file) return;

            document.getElementById('analyzeLoading').style.display = 'block';
            log("Sending /analyze-image request...");
            const formData = new FormData();
            formData.append("file", file);

            try {
                const res = await fetch(`${url}/analyze-image`, { method: 'POST', body: formData });
                const data = await res.json();
                document.getElementById('analyzeLoading').style.display = 'none';

                if (data.status === 'success') {
                    const canvas = document.getElementById('analyzeCanvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    img.onload = () => {
                        const s = 600 / img.width;
                        canvas.width = 600;
                        canvas.height = img.height * s;
                        canvas.style.display = 'block';
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                        ctx.beginPath();
                        ctx.strokeStyle = '#ff00ff';
                        ctx.lineWidth = 3;
                        data.floor_boundary.forEach((pt, i) => {
                            const px = pt.x * s, py = pt.y * s;
                            if (i===0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
                        });
                        ctx.stroke();
                        log(`Analyze success. Points: ${data.floor_boundary.length}`);
                    };
                    img.src = URL.createObjectURL(file);
                }
            } catch (e) {
                log("Error: " + e.message);
                document.getElementById('analyzeLoading').style.display = 'none';
            }
        }
    </script>
</body>
</html>
